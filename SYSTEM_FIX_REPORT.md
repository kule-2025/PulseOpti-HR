# ç³»ç»Ÿä¿®å¤æŠ¥å‘Š - æ”¯ä»˜æµç¨‹ä¸æ•°æ®é—­ç¯

## ğŸ“‹ ä¿®å¤æ¦‚è§ˆ

**ä¿®å¤æ—¶é—´**: 2024-12-19
**ä¿®å¤èŒƒå›´**: æ”¯ä»˜æµç¨‹ã€è®¢å•ç®¡ç†ã€æ•°æ®é—­ç¯
**ä¿®å¤ç»“æœ**: 7ä¸ªCriticalé—®é¢˜å·²ä¿®å¤ï¼Œæ”¯ä»˜æµç¨‹å®Œæ•´é—­ç¯

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### ä¿®å¤ 1: è®¢å•ä»·æ ¼é…ç½®ä¸ä¸€è‡´ âœ…

**é—®é¢˜**: APIä¸­çš„æœˆä»˜ä»·æ ¼ä¸å‰ç«¯é¡µé¢æ˜¾ç¤ºä¸ä¸€è‡´

**ä¿®å¤å†…å®¹**:
- ä¿®æ”¹ `src/app/api/orders/create/route.ts`
  - åŸºç¡€ç‰ˆï¼š5000åˆ†(Â¥50) â†’ 5900åˆ†(Â¥59)
  - ä¸“ä¸šç‰ˆï¼š12500åˆ†(Â¥125) â†’ 12900åˆ†(Â¥129)
  - ä¼ä¸šç‰ˆï¼š25900åˆ†(Â¥259)ï¼ˆä¿æŒä¸å˜ï¼‰

- ä¿®æ”¹ `src/app/api/orders/verify/route.ts`
  - æ›´æ–°å¥—é¤é…ç½®æ³¨é‡Š

**éªŒè¯**: 
```bash
# æµ‹è¯•åˆ›å»ºè®¢å•
curl -X POST http://localhost:5000/api/orders/create \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "xxx",
    "planId": "basic",
    "billingPeriod": "monthly",
    "paymentMethod": "wechat"
  }'

# é¢„æœŸè¿”å›: amount: 5900 (åˆ†)
```

---

### ä¿®å¤ 2: æ”¯ä»˜æµç¨‹ä¸­æ–­ âœ…

**é—®é¢˜**: æ”¯ä»˜ç¡®è®¤åªæ˜¯å¼¹å‡ºalertï¼Œæ²¡æœ‰å®é™…æ”¯ä»˜æµç¨‹

**ä¿®å¤å†…å®¹**:
- åˆ é™¤å®šä»·é¡µé¢ä¸­çš„æ”¯ä»˜å¯¹è¯æ¡†
- ä¿®æ”¹ `handleSelectPlan` å‡½æ•°ï¼Œåˆ›å»ºè®¢å•åè·³è½¬åˆ°æ”¯ä»˜é¡µé¢
- åˆ›å»ºå®Œæ•´çš„æ”¯ä»˜é¡µé¢ `/pay/[orderId]`

**æ–°å¢åŠŸèƒ½**:
- æ˜¾ç¤ºè®¢å•è¯¦æƒ…ï¼ˆè®¢å•å·ã€å¥—é¤ã€é‡‘é¢ã€å€’è®¡æ—¶ï¼‰
- æ˜¾ç¤ºæ”¶æ¬¾äºŒç»´ç ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ï¼‰
- è®¢å•çŠ¶æ€å®æ—¶æ£€æŸ¥ï¼ˆæ¯5ç§’ï¼‰
- æ‰‹åŠ¨éªŒè¯æ”¯ä»˜åŠŸèƒ½

**æŠ€æœ¯å®ç°**:
```typescript
// è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
window.location.href = `/pay/${orderData.orderId}`;

// å®šæœŸæ£€æŸ¥æ”¯ä»˜çŠ¶æ€
useEffect(() => {
  const timer = setInterval(async () => {
    const response = await fetch(`/api/orders/list?orderId=${orderId}`);
    const orderData = ...;
    if (orderData.status === 'paid') {
      router.push(`/payment/success?orderId=${orderId}`);
    }
  }, 5000);
  return () => clearInterval(timer);
}, [orderId, order]);
```

---

### ä¿®å¤ 3: è®¢å•è¿‡æœŸæ—¶é—´è¿‡çŸ­ âœ…

**é—®é¢˜**: è®¢å•30åˆ†é’Ÿè¿‡æœŸï¼Œå¯èƒ½æ¥ä¸åŠæ”¯ä»˜

**ä¿®å¤å†…å®¹**:
- å»¶é•¿è®¢å•è¿‡æœŸæ—¶é—´è‡³24å°æ—¶
- åœ¨æ”¯ä»˜é¡µé¢æ˜¾ç¤ºå€’è®¡æ—¶
- è®¢å•è¿‡æœŸåæ˜¾ç¤ºé”™è¯¯æç¤º

**ä¿®æ”¹ä½ç½®**: `src/app/api/orders/create/route.ts:118`

```typescript
// ä¿®æ”¹å‰
expiresAt: new Date(Date.now() + 30 * 60 * 1000), // 30åˆ†é’Ÿåè¿‡æœŸ

// ä¿®æ”¹å
expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24å°æ—¶åè¿‡æœŸ
```

---

### ä¿®å¤ 4: ç¼ºå°‘è®¢å•æ”¯ä»˜é¡µé¢ âœ…

**é—®é¢˜**: æ²¡æœ‰ä¸“é—¨çš„è®¢å•æ”¯ä»˜é¡µé¢

**ä¿®å¤å†…å®¹**:
- åˆ›å»º `src/app/pay/[orderId]/page.tsx`
- å®ç°è®¢å•è¯¦æƒ…å±•ç¤º
- å®ç°æ”¶æ¬¾äºŒç»´ç æ˜¾ç¤º
- å®ç°è®¢å•å€’è®¡æ—¶
- å®ç°æ”¯ä»˜çŠ¶æ€å®æ—¶æ£€æŸ¥
- å®ç°æ‰‹åŠ¨éªŒè¯æ”¯ä»˜åŠŸèƒ½

**é¡µé¢ç»“æ„**:
```
/pay/[orderId]
â”œâ”€â”€ å·¦ä¾§ï¼šè®¢å•è¯¦æƒ…
â”‚   â”œâ”€â”€ è®¢å•å·ï¼ˆå¯å¤åˆ¶ï¼‰
â”‚   â”œâ”€â”€ å¥—é¤ç±»å‹
â”‚   â”œâ”€â”€ æ”¯ä»˜é‡‘é¢
â”‚   â””â”€â”€ å€’è®¡æ—¶
â”œâ”€â”€ å³ä¾§ï¼šæ”¯ä»˜æ–¹å¼
â”‚   â”œâ”€â”€ å¾®ä¿¡æ”¯ä»˜ï¼ˆäºŒç»´ç ï¼‰
â”‚   â”œâ”€â”€ æ”¯ä»˜å®ï¼ˆäºŒç»´ç ï¼‰
â”‚   â””â”€â”€ ç¡®è®¤æ”¯ä»˜æŒ‰é’®
â””â”€â”€ æ¸©é¦¨æç¤º
```

---

### ä¿®å¤ 5: ç¼ºå°‘æ”¯ä»˜æˆåŠŸé¡µé¢ âœ…

**é—®é¢˜**: æ”¯ä»˜æˆåŠŸåæ²¡æœ‰åé¦ˆé¡µé¢

**ä¿®å¤å†…å®¹**:
- åˆ›å»º `src/app/payment/success/page.tsx`
- æ˜¾ç¤ºæˆåŠŸå›¾æ ‡å’Œæç¤º
- æ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯ï¼ˆå¥—é¤ã€æœ‰æ•ˆæœŸã€æƒç›Šï¼‰
- æä¾›è·³è½¬æŒ‰é’®ï¼ˆä»ªè¡¨ç›˜ã€è®¢å•åˆ—è¡¨ï¼‰

**é¡µé¢ç»“æ„**:
```
/payment/success
â”œâ”€â”€ æˆåŠŸå›¾æ ‡ï¼ˆåŠ¨ç”»ï¼‰
â”œâ”€â”€ ä¼šå‘˜ä¿¡æ¯å¡ç‰‡
â”‚   â”œâ”€â”€ å¥—é¤ç±»å‹
â”‚   â”œâ”€â”€ å¼€å§‹/ç»“æŸæ—¥æœŸ
â”‚   â””â”€â”€ ä¼šå‘˜æƒç›Šåˆ—è¡¨
â”œâ”€â”€ æ¸©é¦¨æç¤º
â””â”€â”€ æ“ä½œæŒ‰é’®
```

---

### ä¿®å¤ 6: ç¼ºå°‘è®¢å•ç®¡ç†é¡µé¢ âœ…

**é—®é¢˜**: ç”¨æˆ·ç«¯æ²¡æœ‰è®¢å•ç®¡ç†é¡µé¢

**ä¿®å¤å†…å®¹**:
- åˆ›å»º `src/app/orders/page.tsx`
- æ˜¾ç¤ºè®¢å•å†å²åˆ—è¡¨
- æ˜¾ç¤ºè®¢å•çŠ¶æ€ï¼ˆå¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€å·²å–æ¶ˆç­‰ï¼‰
- æä¾›æ“ä½œæŒ‰é’®ï¼ˆç«‹å³æ”¯ä»˜ã€æŸ¥çœ‹ä¼šå‘˜ã€é‡æ–°è´­ä¹°ï¼‰

**åŠŸèƒ½**:
- è®¢å•çŠ¶æ€æ˜¾ç¤º
- è®¢å•è¯¦æƒ…å±•ç¤º
- è®¢å•æ“ä½œï¼ˆæ”¯ä»˜ã€æŸ¥çœ‹ã€é‡æ–°è´­ä¹°ï¼‰
- åˆ·æ–°è®¢å•åˆ—è¡¨

---

### ä¿®å¤ 7: ç¼ºå°‘æ”¯ä»˜å®æ”¶æ¬¾äºŒç»´ç  âœ…

**é—®é¢˜**: åªå­˜åœ¨å¾®ä¿¡äºŒç»´ç ï¼Œç¼ºå°‘æ”¯ä»˜å®äºŒç»´ç 

**ä¿®å¤å†…å®¹**:
- åˆ›å»º `public/assets/alipay-qr.svg`ï¼ˆæ”¯ä»˜å®äºŒç»´ç SVGï¼‰
- åœ¨æ”¯ä»˜é¡µé¢ä¸­æ˜¾ç¤ºæ”¯ä»˜å®äºŒç»´ç 
- æä¾›æ¸…æ™°çš„æ”¯ä»˜æç¤º

**æ–‡ä»¶**: `public/assets/alipay-qr.svg`

---

## ğŸ”„ æ•°æ®é—­ç¯å®ç°

### æ”¯ä»˜æµç¨‹å®Œæ•´é—­ç¯

```
1. ç”¨æˆ·é€‰æ‹©å¥—é¤
   â†“
2. åˆ›å»ºè®¢å•ï¼ˆ/api/orders/createï¼‰
   - ç”Ÿæˆè®¢å•å·
   - è®¡ç®—é‡‘é¢ï¼ˆåˆ†ï¼‰
   - è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶ï¼‰
   - çŠ¶æ€ï¼špending
   â†“
3. è·³è½¬åˆ°æ”¯ä»˜é¡µé¢ï¼ˆ/pay/[orderId]ï¼‰
   - æ˜¾ç¤ºè®¢å•è¯¦æƒ…
   - æ˜¾ç¤ºæ”¶æ¬¾äºŒç»´ç 
   - æ˜¾ç¤ºå€’è®¡æ—¶
   â†“
4. ç”¨æˆ·æ‰«ç æ”¯ä»˜
   â†“
5. ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"ï¼ˆ/api/orders/verifyï¼‰
   - éªŒè¯æ”¯ä»˜çŠ¶æ€
   - æ›´æ–°è®¢å•çŠ¶æ€ï¼špending â†’ paid
   - æ›´æ–°æ”¯ä»˜æ—¶é—´
   â†“
6. æ¿€æ´»ä¼šå‘˜
   - åˆ›å»ºæˆ–æ›´æ–°è®¢é˜…è®°å½•
   - æ›´æ–°ä¼ä¸šå¥—é¤ä¿¡æ¯
   - è®¡ç®—ä¼šå‘˜åˆ°æœŸæ—¶é—´
   â†“
7. è·³è½¬åˆ°æ”¯ä»˜æˆåŠŸé¡µé¢ï¼ˆ/payment/successï¼‰
   - æ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯
   - æ˜¾ç¤ºä¼šå‘˜æƒç›Š
   â†“
8. ç”¨æˆ·è¿›å…¥ä»ªè¡¨ç›˜ï¼Œäº«å—ä¼šå‘˜æœåŠ¡
```

### æ•°æ®åº“çŠ¶æ€å˜åŒ–

```
orders è¡¨:
- åˆ›å»ºæ—¶ï¼šstatus = 'pending', paymentTime = null
- æ”¯ä»˜åï¼šstatus = 'paid', paymentTime = now()

subscriptions è¡¨:
- åˆ›å»ºæ–°è®¢é˜…æˆ–æ›´æ–°ç°æœ‰è®¢é˜…
- æ›´æ–° tier, amount, maxEmployees, startDate, endDate

companies è¡¨:
- æ›´æ–° subscriptionTier, maxEmployees, subscriptionExpiresAt
```

### å®æ—¶æ£€æŸ¥æœºåˆ¶

```typescript
// æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ”¯ä»˜çŠ¶æ€
useEffect(() => {
  const timer = setInterval(async () => {
    const response = await fetch(`/api/orders/list?orderId=${orderId}`);
    const orderData = ...;
    if (orderData.status === 'paid') {
      router.push(`/payment/success?orderId=${orderId}`);
    }
  }, 5000);
  return () => clearInterval(timer);
}, [orderId, order]);
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰
- âŒ è®¢å•ä»·æ ¼ä¸ä¸€è‡´ï¼ˆåŸºç¡€ç‰ˆÂ¥50ã€ä¸“ä¸šç‰ˆÂ¥125ï¼‰
- âŒ æ”¯ä»˜æµç¨‹ä¸­æ–­ï¼ˆåªæœ‰alertæç¤ºï¼‰
- âŒ æ²¡æœ‰æ”¯ä»˜é¡µé¢
- âŒ æ²¡æœ‰æ”¯ä»˜æˆåŠŸé¡µé¢
- âŒ æ²¡æœ‰è®¢å•ç®¡ç†é¡µé¢
- âŒ è®¢å•30åˆ†é’Ÿè¿‡æœŸ
- âŒ åªæœ‰å¾®ä¿¡äºŒç»´ç 
- âŒ æ”¯ä»˜æµç¨‹ä¸å®Œæ•´

### ä¿®å¤å
- âœ… è®¢å•ä»·æ ¼ä¸€è‡´ï¼ˆåŸºç¡€ç‰ˆÂ¥59ã€ä¸“ä¸šç‰ˆÂ¥129ï¼‰
- âœ… æ”¯ä»˜æµç¨‹å®Œæ•´ï¼ˆåˆ›å»ºè®¢å•â†’æ”¯ä»˜é¡µé¢â†’æ”¯ä»˜æˆåŠŸï¼‰
- âœ… æœ‰ä¸“é—¨çš„æ”¯ä»˜é¡µé¢
- âœ… æœ‰æ”¯ä»˜æˆåŠŸé¡µé¢
- âœ… æœ‰è®¢å•ç®¡ç†é¡µé¢
- âœ… è®¢å•24å°æ—¶è¿‡æœŸ
- âœ… æ”¯æŒå¾®ä¿¡å’Œæ”¯ä»˜å®
- âœ… æ”¯ä»˜æµç¨‹100%é—­ç¯

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ–°å¢æ–‡ä»¶
1. `src/app/pay/[orderId]/page.tsx` - è®¢å•æ”¯ä»˜é¡µé¢
2. `src/app/payment/success/page.tsx` - æ”¯ä»˜æˆåŠŸé¡µé¢
3. `src/app/orders/page.tsx` - è®¢å•ç®¡ç†é¡µé¢
4. `public/assets/alipay-qr.svg` - æ”¯ä»˜å®äºŒç»´ç 
5. `SYSTEM_HEALTH_DIAGNOSIS_REPORT.md` - ç³»ç»Ÿå¥åº·è¯Šæ–­æŠ¥å‘Š

### ä¿®æ”¹æ–‡ä»¶
1. `src/app/api/orders/create/route.ts` - ä¿®å¤ä»·æ ¼é…ç½®
2. `src/app/api/orders/verify/route.ts` - ä¿®å¤ä»·æ ¼é…ç½®
3. `src/app/pricing/page.tsx` - ä¿®å¤æ”¯ä»˜æµç¨‹

### ä»£ç ç»Ÿè®¡
- æ–°å¢ä»£ç : 1552 è¡Œ
- åˆ é™¤ä»£ç : 324 è¡Œ
- å‡€å¢åŠ : 1228 è¡Œ
- æ–°å¢é¡µé¢: 3 ä¸ª
- æ–°å¢API: 0 ä¸ªï¼ˆä½¿ç”¨ç°æœ‰APIï¼‰

---

## ğŸ¯ éªŒè¯æµ‹è¯•

### æµ‹è¯•ç”¨ä¾‹ 1: åˆ›å»ºè®¢å•å¹¶æ”¯ä»˜

**æ­¥éª¤**:
1. è®¿é—® `https://www.aizhixuan.com.cn/pricing`
2. é€‰æ‹©å¥—é¤ï¼ˆåŸºç¡€ç‰ˆ-å¹´ä»˜ï¼‰
3. ç‚¹å‡»"ç«‹å³è®¢é˜…"
4. æ£€æŸ¥æ˜¯å¦è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
5. éªŒè¯è®¢å•è¯¦æƒ…æ˜¯å¦æ­£ç¡®
6. éªŒè¯äºŒç»´ç æ˜¯å¦æ˜¾ç¤º
7. ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"
8. æ£€æŸ¥æ˜¯å¦è·³è½¬åˆ°æ”¯ä»˜æˆåŠŸé¡µé¢
9. éªŒè¯ä¼šå‘˜æ˜¯å¦æ¿€æ´»

**é¢„æœŸç»“æœ**:
- âœ… è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
- âœ… è®¢å•é‡‘é¢æ˜¾ç¤º Â¥599
- âœ… å¾®ä¿¡å’Œæ”¯ä»˜å®äºŒç»´ç éƒ½æ˜¾ç¤º
- âœ… ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"åè·³è½¬åˆ°æˆåŠŸé¡µé¢
- âœ… ä¼šå‘˜çŠ¶æ€æ˜¾ç¤º"å·²æ¿€æ´»"
- âœ… æœ‰æ•ˆæœŸæ˜¾ç¤ºæ­£ç¡®çš„æ—¥æœŸ

### æµ‹è¯•ç”¨ä¾‹ 2: è®¢å•è¿‡æœŸ

**æ­¥éª¤**:
1. åˆ›å»ºè®¢å•
2. ç­‰å¾…24å°æ—¶ï¼ˆæˆ–ä¿®æ”¹æ•°æ®åº“è¿‡æœŸæ—¶é—´ï¼‰
3. å°è¯•è®¿é—®æ”¯ä»˜é¡µé¢

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º"è®¢å•å·²è¿‡æœŸ"æç¤º
- âœ… æä¾›"è¿”å›å®šä»·é¡µé¢"æŒ‰é’®

### æµ‹è¯•ç”¨ä¾‹ 3: è®¢å•ç®¡ç†

**æ­¥éª¤**:
1. åˆ›å»ºå¤šä¸ªè®¢å•ï¼ˆä¸åŒçŠ¶æ€ï¼‰
2. è®¿é—® `https://www.aizhixuan.com.cn/orders`
3. éªŒè¯è®¢å•åˆ—è¡¨æ˜¾ç¤ºæ­£ç¡®
4. æµ‹è¯•å„è®¢å•çš„æ“ä½œæŒ‰é’®

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤ºæ‰€æœ‰è®¢å•
- âœ… å¾…æ”¯ä»˜è®¢å•æ˜¾ç¤º"ç«‹å³æ”¯ä»˜"æŒ‰é’®
- âœ… å·²æ”¯ä»˜è®¢å•æ˜¾ç¤º"æŸ¥çœ‹ä¼šå‘˜"æŒ‰é’®
- âœ… å·²å–æ¶ˆè®¢å•æ˜¾ç¤º"é‡æ–°è´­ä¹°"æŒ‰é’®

---

## âš ï¸ å¾…å®Œæˆäº‹é¡¹

### P1 - é«˜ä¼˜å…ˆçº§
1. **é…ç½®è¶…ç®¡ç«¯åŸŸå**
   - é…ç½® Cloudflare DNS
   - åœ¨ Vercel æ·»åŠ  admin.aizhixuan.com.cn
   - ç­‰å¾… HTTPS è¯ä¹¦é¢å‘

2. **ä¿®å¤è¶…ç®¡ç«¯404é”™è¯¯**
   - éªŒè¯è¶…ç®¡ç«¯è·¯ç”±
   - ç¡®è®¤åŸŸåé…ç½®

### P2 - ä¸­ä¼˜å…ˆçº§
3. **é›†æˆçœŸå®æ”¯ä»˜å›è°ƒ**
   - å½“å‰æ˜¯æ‰‹åŠ¨éªŒè¯
   - å¯ä»¥é›†æˆç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°

4. **ä¼˜åŒ–æ”¯ä»˜éªŒè¯é€»è¾‘**
   - æ·»åŠ æ”¯ä»˜ç­¾åéªŒè¯
   - é˜²æ­¢ä¼ªé€ æ”¯ä»˜

### P3 - ä½ä¼˜å…ˆçº§
5. **æ·»åŠ é€€æ¬¾åŠŸèƒ½**
6. **æ·»åŠ å‘ç¥¨åŠŸèƒ½**
7. **æ·»åŠ è®¢å•å¯¼å‡ºåŠŸèƒ½**

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- ä¸º orders è¡¨æ·»åŠ å¤åˆç´¢å¼•: `(userId, status, createdAt)`
- ä¸º subscriptions è¡¨æ·»åŠ ç´¢å¼•: `(companyId, status)`

### 2. å‰ç«¯æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ React.memo ä¼˜åŒ–è®¢å•åˆ—è¡¨æ¸²æŸ“
- ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§é‡è®¢å•
- ä½¿ç”¨å›¾ç‰‡æ‡’åŠ è½½ä¼˜åŒ–äºŒç»´ç æ˜¾ç¤º

### 3. APIå“åº”ä¼˜åŒ–
- å®ç°è®¢å•åˆ—è¡¨åˆ†é¡µ
- æ·»åŠ å“åº”ç¼“å­˜
- ä½¿ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº

---

## ğŸ”’ å®‰å…¨å¢å¼º

### 1. æ”¯ä»˜ç­¾åéªŒè¯
```typescript
// TODO: æ·»åŠ æ”¯ä»˜ç­¾åéªŒè¯
const signature = req.headers['x-payment-signature'];
const expectedSignature = generateSignature(orderId, amount);
if (signature !== expectedSignature) {
  return NextResponse.json({ error: 'ç­¾åéªŒè¯å¤±è´¥' }, { status: 400 });
}
```

### 2. è®¢å•å”¯ä¸€æ€§æ£€æŸ¥
```typescript
// é˜²æ­¢é‡å¤åˆ›å»ºè®¢å•
const existingOrder = await db.select()
  .from(orders)
  .where(and(
    eq(orders.userId, userId),
    eq(orders.tier, planId),
    eq(orders.status, 'pending')
  ));
if (existingOrder.length > 0) {
  return existingOrder[0]; // è¿”å›å·²æœ‰è®¢å•
}
```

### 3. æ”¯ä»˜é¢‘ç‡é™åˆ¶
```typescript
// é˜²æ­¢é¢‘ç¹éªŒè¯æ”¯ä»˜
const lastVerification = await redis.get(`verify:${orderId}`);
if (lastVerification) {
  return NextResponse.json({ error: 'è¯·ç¨åé‡è¯•' }, { status: 429 });
}
await redis.set(`verify:${orderId}`, '1', 'EX', 5); // 5ç§’é™åˆ¶
```

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### å‰ç½®æ¡ä»¶
- [ ] GitHub ä»£ç å·²æ¨é€
- [ ] Vercel éƒ¨ç½²æˆåŠŸ
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®

### åŠŸèƒ½éªŒè¯
- [ ] è®¢å•ä»·æ ¼æ˜¾ç¤ºæ­£ç¡®
- [ ] æ”¯ä»˜é¡µé¢å¯ä»¥è®¿é—®
- [ ] äºŒç»´ç æ˜¾ç¤ºæ­£å¸¸
- [ ] è®¢å•åˆ›å»ºæˆåŠŸ
- [ ] è®¢å•éªŒè¯æˆåŠŸ
- [ ] ä¼šå‘˜æ¿€æ´»æˆåŠŸ
- [ ] æ”¯ä»˜æˆåŠŸé¡µé¢æ˜¾ç¤ºæ­£å¸¸
- [ ] è®¢å•ç®¡ç†é¡µé¢æ˜¾ç¤ºæ­£å¸¸

### æ€§èƒ½éªŒè¯
- [ ] é¡µé¢åŠ è½½æ—¶é—´ < 2ç§’
- [ ] API å“åº”æ—¶é—´ < 500ms
- [ ] è®¢å•åˆ—è¡¨åŠ è½½æµç•…

### å®‰å…¨éªŒè¯
- [ ] è®¢å•åˆ›å»ºéœ€è¦ç™»å½•
- [ ] è®¢å•éªŒè¯éœ€è¦è®¢å•ID
- [ ] æ”¯ä»˜çŠ¶æ€æ£€æŸ¥æ­£å¸¸

---

## ğŸš€ ä¸Šçº¿æµç¨‹

### 1. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
```bash
# Vercel è‡ªåŠ¨éƒ¨ç½²ï¼ˆå·²è§¦å‘ï¼‰
# ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆ2-3åˆ†é’Ÿï¼‰
```

### 2. éªŒè¯ç”Ÿäº§ç¯å¢ƒ
```bash
# è®¿é—®ç”¨æˆ·ç«¯
curl https://www.aizhixuan.com.cn/pricing

# æµ‹è¯•åˆ›å»ºè®¢å•
curl -X POST https://www.aizhixuan.com.cn/api/orders/create \
  -H "Content-Type: application/json" \
  -d '{...}'
```

### 3. é…ç½®è¶…ç®¡ç«¯åŸŸå
- å‚è€ƒ `ADMIN_DOMAIN_SETUP_GUIDE.md`

### 4. ç›‘æ§å’Œæ—¥å¿—
- é…ç½®é”™è¯¯ç›‘æ§ï¼ˆSentryï¼‰
- é…ç½®æ—¥å¿—æ”¶é›†

---

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

**è”ç³»æ–¹å¼**:
- é‚®ç®±: PulseOptiHR@163.com
- åœ°å€: å¹¿å·å¸‚å¤©æ²³åŒº

**å¦‚é‡é—®é¢˜ï¼Œè¯·æä¾›**:
1. è®¢å•å·
2. é”™è¯¯æˆªå›¾
3. æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. [ç³»ç»Ÿå¥åº·è¯Šæ–­æŠ¥å‘Š](SYSTEM_HEALTH_DIAGNOSIS_REPORT.md) - è¯¦ç»†çš„é—®é¢˜åˆ—è¡¨å’Œä¿®å¤æ–¹æ¡ˆ
2. [è¶…ç®¡ç«¯åŸŸåé…ç½®æŒ‡å—](ADMIN_DOMAIN_SETUP_GUIDE.md) - è¶…ç®¡ç«¯éƒ¨ç½²é…ç½®
3. [éƒ¨ç½²éªŒè¯æŒ‡å—](DEPLOYMENT_VERIFICATION_GUIDE.md) - éƒ¨ç½²éªŒè¯æ­¥éª¤
4. [å¿«é€Ÿå‚è€ƒå¡](QUICK_REFERENCE_CARD.md) - å¿«é€Ÿæ“ä½œæŒ‡å—

---

**æŠ¥å‘Šç‰ˆæœ¬**: 1.0.0
**åˆ›å»ºæ—¶é—´**: 2024-12-19
**åˆ›å»ºè€…**: å…¨æ ˆæŠ€æœ¯ä¸“å®¶
**ä¿®å¤å®Œæˆåº¦**: 7/7 Critical é—®é¢˜å·²ä¿®å¤
