# PulseOpti HR 账号体系重构设计文档

## 1. 概述

本文档定义了PulseOpti HR平台的多层级企业账号体系与独立的开发者运维体系，确保账号间权限清晰、数据隔离、连接顺畅。

## 2. 账号类型定义

### 2.1 企业账号体系（基于 companyId 隔离）

#### 2.1.1 主账号（main_account）
- **定义**：企业最高权限账号，每个企业唯一
- **创建权限**：系统自动创建（企业注册时）
- **数量限制**：1个/企业
- **核心职责**：
  - 管理企业套餐订阅
  - 创建和管理子账号
  - 审批子账号创建员工号
  - 配置企业级设置
  - 查看企业级报表

#### 2.1.2 子账号（sub_account）
- **定义**：由主账号创建的管理账号，具备部门级管理权限
- **创建权限**：主账号创建
- **数量限制**：受套餐的 maxSubAccounts 限制
- **核心职责**：
  - 管理所属部门的员工号
  - 查看和管理部门数据
  - 配置部门级设置
  - 创建和分配任务

#### 2.1.3 员工号（employee）
- **定义**：普通员工账号，用于日常HR业务操作
- **创建权限**：子账号创建（需主账号审批或配额内）
- **数量限制**：受套餐的 maxEmployees 限制
- **核心职责**：
  - 查看和编辑个人信息
  - 执行日常工作任务
  - 提交请假、报销等申请
  - 查看分配给本人的数据

### 2.2 开发者运维体系（独立隔离）

#### 2.2.1 开发者（developer）
- **定义**：系统运维监控账号，用于平台监控、订单管理、运维操作
- **创建权限**：系统内置，不可外部创建
- **数量限制**：不受企业套餐限制，独立管理
- **核心职责**：
  - 监控订单状态
  - 执行运维操作
  - 处理收退款
  - 查看系统级监控数据

## 3. 账号关系图

```
企业 A (companyId: xxx)
├── 主账号 (userType: main_account, parentUserId: null)
│   ├── 子账号 1 (userType: sub_account, parentUserId: mainAccountId)
│   │   ├── 员工号 1 (userType: employee, parentUserId: subAccountId1)
│   │   └── 员工号 2 (userType: employee, parentUserId: subAccountId1)
│   └── 子账号 2 (userType: sub_account, parentUserId: mainAccountId)
│       └── 员工号 3 (userType: employee, parentUserId: subAccountId2)

企业 B (companyId: yyy)
├── 主账号 (userType: main_account, parentUserId: null)
│   └── ...

开发者体系（独立）
├── 开发者 1 (userType: developer, companyId: null, parentUserId: null)
├── 开发者 2 (userType: developer, companyId: null, parentUserId: null)
└── ...
```

## 4. 核心权限矩阵

| 权限模块 | 主账号 | 子账号 | 员工号 | 开发者 |
|---------|-------|-------|-------|-------|
| **企业设置** |
| - 查看企业信息 | ✅ | ❌ | ❌ | ❌ |
| - 编辑企业信息 | ✅ | ❌ | ❌ | ❌ |
| - 管理套餐订阅 | ✅ | ❌ | ❌ | ❌ |
| - 查看企业报表 | ✅ | 仅部门 | ❌ | ❌ |
| **账号管理** |
| - 创建子账号 | ✅ | ❌ | ❌ | ❌ |
| - 删除子账号 | ✅ | ❌ | ❌ | ❌ |
| - 创建员工号 | ✅ | 仅部门 | ❌ | ❌ |
| - 删除员工号 | ✅ | 仅部门 | ❌ | ❌ |
| - 重置密码 | ✅ | 仅部门 | 仅自己 | ❌ |
| **人事管理** |
| - 查看所有员工 | ✅ | 仅部门 | 仅自己 | ❌ |
| - 编辑员工信息 | ✅ | 仅部门 | 仅自己 | ❌ |
| - 创建职位 | ✅ | 仅部门 | ❌ | ❌ |
| - 部门管理 | ✅ | 仅部门 | ❌ | ❌ |
| **招聘管理** |
| - 创建招聘职位 | ✅ | ✅ | ❌ | ❌ |
| - 查看候选人 | ✅ | 仅部门 | 仅自己 | ❌ |
| - 安排面试 | ✅ | ✅ | ❌ | ❌ |
| - 发送Offer | ✅ | ✅ | ❌ | ❌ |
| **绩效管理** |
| - 创建考核周期 | ✅ | ✅ | ❌ | ❌ |
| - 查看绩效记录 | ✅ | 仅部门 | 仅自己 | ❌ |
| - 评分 | ✅ | ✅ | ❌ | ❌ |
| **实时连接** |
| - 即时消息 | ✅（同级/下级） | ✅（同级/下属） | ✅（上级） | ❌ |
| - 任务指派 | ✅（子账号/员工） | ✅（员工） | ❌ | ❌ |
| - 状态同步 | ✅ | ✅ | ✅ | ❌ |
| **运维监控**（开发者专属） |
| - 监控订单 | ❌ | ❌ | ❌ | ✅ |
| - 执行运维 | ❌ | ❌ | ❌ | ✅ |
| - 处理退款 | ❌ | ❌ | ❌ | ✅ |
| - 查看系统日志 | ❌ | ❌ | ❌ | ✅ |

## 5. 数据访问边界

### 5.1 企业账号体系（按 companyId 隔离）
- **主账号**：可访问公司内所有数据
- **子账号**：仅可访问所属部门及下属数据
- **员工号**：仅可访问本人相关数据

### 5.2 开发者账号体系（完全隔离）
- **开发者账号**：
  - companyId 为 null（表示不属于任何企业）
  - parentUserId 为 null
  - 仅可访问系统级运维数据（订单、支付、日志）
  - 不可访问任何企业的人事数据

## 6. 实时连接机制

### 6.1 连接规则
- **即时消息**：账号间在有权限关系时（上下级或同级）可发送即时消息
- **任务指派**：上级账号可向子账号/员工号指派任务
- **状态同步**：账号间可同步任务状态、审批状态等

### 6.2 权限隔离原则
- **消息内容**：仅限工作沟通，不可透露其他数据
- **任务范围**：任务仅可指派给有管理关系的账号
- **状态同步**：仅同步与任务相关的状态信息，不同步业务数据

### 6.3 连接关系表设计
```sql
CREATE TABLE account_connections (
  id VARCHAR(36) PRIMARY KEY,
  from_user_id VARCHAR(36) NOT NULL,
  to_user_id VARCHAR(36) NOT NULL,
  connection_type VARCHAR(20) NOT NULL, -- direct, indirect
  permissions JSONB NOT NULL, -- ["message", "task_assign", "status_sync"]
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(from_user_id, to_user_id)
);
```

## 7. 配额管理

### 7.1 套餐配额配置
```json
{
  "free": {
    "maxEmployees": 30,
    "maxSubAccounts": 1,
    "maxMainAccounts": 1
  },
  "basic": {
    "maxEmployees": 100,
    "maxSubAccounts": 5,
    "maxMainAccounts": 1
  },
  "professional": {
    "maxEmployees": 500,
    "maxSubAccounts": 20,
    "maxMainAccounts": 1
  },
  "enterprise": {
    "maxEmployees": -1, // 无限制
    "maxSubAccounts": -1, // 无限制
    "maxMainAccounts": 1
  }
}
```

### 7.2 配额检查逻辑
1. 创建子账号前：检查 `当前子账号数 < maxSubAccounts`
2. 创建员工号前：检查 `当前员工号数 < maxEmployees`
3. 主账号数量：永远为1，不可创建第二个

## 8. 数据库Schema变更

### 8.1 users 表字段变更
```sql
-- 新增字段
ALTER TABLE users ADD COLUMN user_type VARCHAR(20) NOT NULL DEFAULT 'employee';
-- 可能值: main_account, sub_account, employee, developer

-- 保留现有字段
-- role: 用于RBAC权限（super_admin, admin, manager, employee）
-- parentUserId: 关联的父账号ID
-- companyId: 企业ID（开发者账号为null）

-- 索引优化
CREATE INDEX users_user_type_idx ON users(user_type);
CREATE INDEX users_company_id_user_type_idx ON users(company_id, user_type);
```

### 8.2 新增表
- `account_connections`: 账号连接关系表
- `account_quotas`: 账号配额快照表（可选，用于审计）

## 9. API接口设计

### 9.1 账号管理接口
- `POST /api/accounts/create` - 创建账号（主账号创建子账号/员工号）
- `GET /api/accounts/list` - 获取账号列表（按类型筛选）
- `PUT /api/accounts/:id` - 更新账号信息
- `DELETE /api/accounts/:id` - 删除账号
- `POST /api/accounts/:id/reset-password` - 重置密码

### 9.2 权限校验接口
- `GET /api/accounts/:id/permissions` - 获取账号权限列表
- `POST /api/accounts/check-permission` - 检查账号是否有指定权限

### 9.3 实时连接接口
- `GET /api/connections/list` - 获取可连接的账号列表
- `POST /api/connections/message` - 发送即时消息
- `POST /api/connections/assign-task` - 指派任务
- `PUT /api/connections/sync-status` - 同步状态

## 10. 前端页面设计

### 10.1 账号管理页面
- 主账号视图：显示子账号列表、员工号总数、配额使用情况
- 子账号视图：显示所属员工号列表、部门数据
- 员工号视图：仅显示个人信息

### 10.2 实时通讯界面
- 消息列表：显示可联系的账号（按权限过滤）
- 任务指派：选择目标账号指派任务
- 状态同步：显示实时状态更新

## 11. 安全与审计

### 11.1 操作审计
- 所有账号创建、删除、修改操作记录审计日志
- 权限变更记录审计日志
- 实时连接操作记录审计日志

### 11.2 数据加密
- 密码使用 bcrypt 加密
- 敏感信息（手机号、身份证）使用 AES 加密存储

## 12. 迁移策略

### 12.1 现有数据迁移
1. 分析现有 users 表数据
2. 根据规则转换 userType：
   - isMainAccount=true → main_account
   - parentUserId 非空 → sub_account
   - role=employee 且非主账号/子账号 → employee
3. 创建开发者账号（手动创建）
4. 验证数据完整性

### 12.2 灰度发布
1. 先更新数据库Schema
2. 部署新版本代码
3. 小范围测试账号创建、权限校验
4. 全量发布

## 13. 注意事项

1. **配额超限**：创建账号前必须检查配额，超限返回明确错误提示
2. **权限隔离**：开发者账号不可访问任何企业数据，企业账号不可访问运维数据
3. **实时连接**：仅限有权限关系的账号连接，防止数据泄露
4. **数据迁移**：迁移前必须备份数据，迁移后必须验证
5. **性能优化**：大量账号查询时，必须使用索引优化查询性能
